@page "/reservation"
@using System.Globalization

@using Domain.Entities
@using Application.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@inject IReservationRepository ReservationRepository
@inject ISeatRepository SeatRepository
@inject IRoomRepository RoomRepository
@inject AuthenticationStateProvider AuthenticationStateProvider

@attribute [Authorize]

<h2 class="text-2xl font-bold mb-4">Rezervace místnosti</h2>

<label>Vyber datum:</label>
<input type="date" @bind="SelectedDateString" @bind:format="yyyy-MM-dd" class="border p-2 mb-4" />

<!-- Dočasně bez ErrorBoundary, ať se UI neblokuje -->
@if (Rooms is null)
{
    <p>Načítám místnosti…</p>
}
else if (!Rooms.Any())
{
    <p>Žádné místnosti k dispozici.</p>
}
else
{
    @foreach (var room in Rooms)
    {
        <h3 class="text-xl font-semibold mt-6">@room.Name</h3>
        <div class="room-container">
            @foreach (var seat in (room.Seats ?? Enumerable.Empty<Seat>()))
            {
                <button @key="seat.Id"
                        type="button"
                        class="@GetSeatCss(seat)"
                        @onclick="() => SelectSeat(seat)">
                    @seat.Code
                </button>
            }
        </div>
    }

    @if (SelectedSeat is not null)
    {
        <div class="mt-4 p-4 bg-light border rounded shadow-sm">
            <div>Vybráno: @SelectedSeat.Code</div>

            <h4>Chcete rezervovat místo?</h4>

            <p>
                <strong>Místnost:</strong> @SelectedSeat.Room?.Name<br />
                <strong>Místo:</strong> @SelectedSeat.Code<br />
                <strong>Datum:</strong> @SelectedDate.ToShortDateString()
            </p>

            <div class="mt-2">
                <button type="button" class="btn btn-primary" @onclick="ReserveSeat">
                    Potvrdit rezervaci
                </button>

                <button type="button" class="btn btn-secondary ms-2" @onclick="CancelSelection">
                    Zrušit
                </button>
            </div>
        </div>
    }

    <p><em>Datum:</em> @SelectedDate.ToShortDateString()</p>
    <p><em>Vybraný seat:</em> @(SelectedSeat?.Code ?? "žádný")</p>
}

<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="Inc">Test klik</button>
<p>count: @count</p>

@code {
    List<Room>? Rooms;
    List<Reservation> Reservations = new();
    Seat? SelectedSeat;

    DateTime SelectedDate = DateTime.Today;

    string SelectedDateString
    {
        get => SelectedDate.ToString("yyyy-MM-dd");
        set
        {
            try
            {
                if (!string.IsNullOrWhiteSpace(value))
                {
                    SelectedDate = DateTime.ParseExact(value, "yyyy-MM-dd", CultureInfo.InvariantCulture).Date;
                    SelectedSeat = null;

                    // Klíčové: nevolat fire-and-forget Task bez zachycení
                    _ = InvokeAsync(async () =>
                    {
                        Reservations = await ReservationRepository.GetByDateAsync(SelectedDate);
                        StateHasChanged();
                    });
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Parsování data selhalo: {ex}");
            }
        }
    }

    private void SelectSeat(Seat seat)
    {
        Console.WriteLine($"SelectSeat called for seat {seat.Id} {seat.Code}");
        SelectedSeat = seat;
        StateHasChanged();
    }

    private async Task ReserveSeat()
    {
        try
        {
            if (SelectedSeat is null)
                return;

            var auth = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = auth.User;
            if (!user.Identity?.IsAuthenticated ?? true)
                return;

            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrWhiteSpace(userId))
                return;

            // finální kontrola, zda mezitím neobsazeno
            if (IsSeatOccupied(SelectedSeat, SelectedDate))
                return;

            var newReservation = new Reservation
            {
                SeatId = SelectedSeat.Id,
                UserId = userId,
                BookDate = DateOnly.FromDateTime(SelectedDate),
                CreateDate = DateTime.UtcNow
            };

            await ReservationRepository.CreateAsync(newReservation);

            Reservations = await ReservationRepository.GetByDateAsync(SelectedDate);
            SelectedSeat = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Rezervace selhala: {ex}");
        }
    }

    private void CancelSelection() => SelectedSeat = null;

    private async Task ReloadReservationsForSelectedDate()
    {
        try
        {
            Reservations = await ReservationRepository.GetByDateAsync(SelectedDate);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Načtení rezervací selhalo: {ex}");
        }
    }

    private bool IsSeatOccupied(Seat seat, DateTime date)
    {
        return Reservations.Any(r =>
            r.SeatId == seat.Id &&
            r.BookDate.ToDateTime(TimeOnly.MinValue).Date == date.Date);
    }

    string GetSeatCss(Seat seat)
    {
        try
        {
            bool isOccupied = IsSeatOccupied(seat, SelectedDate);
            if (isOccupied) return "seat-occupied";
            if (SelectedSeat?.Id == seat.Id) return "seat-selected";
            return "seat-free";
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"GetSeatCss error: {ex}");
            return "seat-free";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Rooms = await RoomRepository.GetAllWithSeatsAsync();
            Reservations = await ReservationRepository.GetByDateAsync(SelectedDate);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Inicializace selhala: {ex}");
        }
    }

    int count;
    void Inc()
    {
        count++;
        Console.WriteLine($"Inc => {count}");
        StateHasChanged();
    }
}

<style>
    .room-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .seat-free {
        background: #d1fae5;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #10b981;
    }

    .seat-selected {
        background: #93c5fd;
        padding: 10px 20px;
        border-radius: 6px;
        border: 2px solid #2563eb;
        cursor: pointer;
    }

    .seat-occupied {
        background: #fca5a5;
        padding: 10px 20px;
        border-radius: 6px;
        border: 1px solid #ef4444;
        cursor: not-allowed;
    }
</style>

<button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => { Console.WriteLine("Test klikujte"); SelectedSeat = null; StateHasChanged(); }">
    Test klik
</button>