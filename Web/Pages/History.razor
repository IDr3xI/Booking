@page "/history"
@using Domain.Entities
@using Application.Interfaces
@using Microsoft.AspNetCore.Components.Authorization

<h3>Moje rezervace</h3>

@if (isLoading)
{
    <p>Načítám rezervace...</p>
}
else if (Reservations is null || !Reservations.Any())
{
    <p>Nemáte žádné rezervace.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Místnost</th>
                <th>Sedadlo</th>
                <th>Datum</th>
                <th>Vytvořeno</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in Reservations)
            {
                <tr>
                    <td>@r.Seat?.Room?.Name</td>
                    <td>@r.Seat?.Code</td>
                    <td>@r.BookDate.ToShortDateString()</td>
                    <td>@r.CreateDate.ToString("g")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Reservation> Reservations = new();
    private bool isLoading = true;

    [Inject] IReservationRepository ReservationRepository { get; set; }
    [Inject] AuthenticationStateProvider AuthenticationStateProvider { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            Reservations = new();
            isLoading = false;
            return;
        }

        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrWhiteSpace(userId))
        {
            Reservations = new();
            isLoading = false;
            return;
        }

        Reservations = await ReservationRepository.GetByUserAsync(userId);
        isLoading = false;
    }
}
